@using CR.DataAccess.Enums
@model List<CR.Core.DTOs.ChatUsers.ChatUserForConsumerDto>
<!-- Page Content -->
<div class="container-fluid">
    <div class="row">
        <div class="col-xl-12">
            <div class="chat-window">
                <!-- Chat Left -->
                <div class="chat-cont-left">
                    <div class="chat-header">
                        <span>چت </span>
                        <a href="javascript:void(0)" class="chat-compose">
                            <i class="material-icons">control_point</i>
                        </a>
                    </div>
                    <form class="chat-search">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <i class="fas fa-search"></i>
                            </div>
                            <input type="text" class="form-control" placeholder="جستجو" id="searchKey" name="searchKey">
                        </div>
                    </form>
                    <div class="chat-users-list">
                        <div id="chatUser-List" class="chat-scroll">
                            @if (Model.Count > 0)
                            {
                                @foreach (var chatUser in Model)
                                {
                                    <a id="chatUser_@chatUser.Id" onclick="SetChatUserId(@chatUser.Id)" class="media read-chat">
                                        <div class="media-img-wrap">
                                            <div class="avatar avatar-online">
                                                <img src="~/@chatUser.ExpertIconSrc" alt="@chatUser.ExpertIconSrc" class="avatar-img rounded-circle">
                                            </div>
                                        </div>
                                        <div class="media-body">
                                            <div>
                                                <div class="user-name">@chatUser.ExpertName</div>
                                                <div class="user-last-chat">@chatUser.LastMessage</div>
                                            </div>
                                            <div>
                                                <div class="last-chat-time block">@chatUser.AppointmentDate</div>
                                                <div class="last-chat-time block">@chatUser.MessageType</div>
                                            </div>
                                        </div>
                                    </a>
                                }
                            }
                        </div>
                    </div>
                </div>
                <!-- /Chat Left -->
                <!-- Chat Right -->
                <div class="chat-cont-right">
                    <div class="chat-header">
                        <a id="back_user_list" class="back-user-list">
                            <i class="material-icons">chevron_left</i>
                        </a>
                        <div class="media">
                            <div class="media-img-wrap">
                                <div class="avatar avatar-online">
                                    <img id="consumerImage" src="~/assets/img/favicon-32x32.png" alt="User Image" class="avatar-img rounded-circle">
                                </div>
                            </div>
                            <div class="media-body">
                                <div id="consumerName" class="user-name"></div>
                            </div>
                        </div>
                    </div>
                    <div class="chat-body">
                        <div class="chat-scroll">
                            <ul id="messages-Body-Consumer" class="list-unstyled">
                            </ul>
                        </div>
                    </div>
                    <div class="chat-footer">
                        <div id="voice" class="input-group">
                            <div id="controls">
                                <button id="recordButton">شروع</button>
                                <button id="pauseButton" disabled>توقف</button>
                                <button id="stopButton" disabled>پایان</button>
                            </div>
                            <div id="formats"></div>
                            <ol id="recordingsList"></ol>
                        </div>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <div class="btn-file btn">
                                    <i class="fa fa-paperclip"></i>
                                    <input type="file" id="image">
                                </div>
                            </div>
                            <input id="message" type="text" class="input-msg-send form-control" placeholder="چیزی تایپ کنید ">
                            <div class="input-group-append">
                                <button@* onclick="AddNewMessage()"*@ id="sendButton" type="button" class="btn msg-send-btn"><i class="fab fa-telegram-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- /Row -->
</div>
<!-- /Page Content -->
@section Scripts
{
<script src="~/assets/js/RecorderForConsumer/recorder.js"></script>
<script src="~/assets/js/RecorderForConsumer/app.js"></script>

<script>

    $(document).ready(function() {
        var element = document.getElementById("voice");
        element.style.visibility = 'hidden';
    });

    var ChatUserId = 0;

    function SetChatUserId(chatUserId) {
        ChatUserId = chatUserId;

        GetMessages(chatUserId);
    }

    function GetMessages(chatUserId) {

        $("#chatUser-List .active").removeClass("active");
        $("#chatUser_" + chatUserId).addClass("active");

        var data = {};

        data["chatUserId"] = chatUserId;

        $.ajax({
            type: 'POST',
            dataType: 'json',
            url: '/api/Chat/GetConsumerMessages',
            cache: false,
            contentType: "application/json; charset=utf-8",
            enctype: 'application/json',
            data: JSON.stringify(data),
            beforeSend: function(x) {
                $('#loading').show(0);
            },
            success: function (response) {
                if (response.isSuccess === true) {
                    var model = response.data;
                    var element = document.getElementById("voice");

                    if (model.isVoice === true) {
                        
                        element.style.visibility = 'visible';
                    }
                    else{

                        element.style.visibility = 'hidden';
                    }


                    $("#messages-Body-Consumer").html("");
                    var body = "";

                    for (let i = 0; i < model.chatMessageDtos.length; i++) {
                        if (model.chatMessageDtos[i].messageFlag === 1) {
                            body += '<li class="media sent">';
                            body += '<div class="media-body">';
                            if (model.chatMessageDtos[i].message !== null) {
                                body += '<div class="msg-box">';
                                body += '<div>';
                                body += '<p>';
                                body += model.chatMessageDtos[i].message;
                                body += '</p>';
                                body += '<ul class="chat-msg-info">';
                                body += '<li>';
                                body += '<div class="chat-time">';
                                body += '<span>';
                                body += model.chatMessageDtos[i].messageHour;
                                body += '</span>';
                                body += '</div>';
                                body += '</li>';
                                body += '</ul>';
                                body += '</div>';
                                body += '</div>';
                            }
                            if (model.chatMessageDtos[i].hasFile) {
                                body += '<div class="msg-box">';
                                body += '<div>';
                                body += '<div class="chat-msg-attachments">';
                                body += '<div class="chat-attachment">';
                                body += '<img src="/' + model.chatMessageDtos[i].file + '" alt="Attachment">';
                                body += '<div class="chat-attach-caption"></div>';
                                body += '<a href="#" class="chat-attach-download">';
                                body += '<i class="fas fa-download"></i>';
                                body += '</a>';
                                body += '</div>';
                                body += '</div>';
                                body += '<ul class="chat-msg-info">';
                                body += '<li>';
                                body += '<div class="chat-time">';
                                body += '<span>' + model.chatMessageDtos[i].messageHour + '</span>';
                                body += '</div>';
                                body += '</li>';
                                body += '</ul>';
                                body += '</div>';
                                body += '</div>';
                            }
                            if (model.chatMessageDtos[i].hasAudio) {
                                body += '<div class="msg-box">';
                                body += '<div>';
                                body += '<div class="chat-msg-attachments">';
                                body += '<audio controls>';
                                body += '<source src="/' + model.chatMessageDtos[i].audio + '" type="audio/ogg">';
                                body += '</audio>';
                                body += '</div>';
                                body += '<ul class="chat-msg-info">';
                                body += '<li>';
                                body += '<div class="chat-time">';
                                body += '<span>' + model.chatMessageDtos[i].messageHour + '</span>';
                                body += '</div>';
                                body += '</li>';
                                body += '</ul>';
                                body += '</div>';
                                body += '</div>';
                            }
                            body += '</div>';
                            body += '</li>';

                        } else {
                            body += '<li class="media received">';
                            body += '<div class="media-body">';
                            if (model.chatMessageDtos[i].message !== null) {
                                body += '<div class="msg-box">';
                                body += '<div>';
                                body += '<p>';
                                body += model.chatMessageDtos[i].message;
                                body += '</p>';
                                body += '<ul class="chat-msg-info">';
                                body += '<li>';
                                body += '<div class="chat-time">';
                                body += '<span>';
                                body += model.chatMessageDtos[i].messageHour;
                                body += '</span>';
                                body += '</div>';
                                body += '</li>';
                                body += '</ul>';
                                body += '</div>';
                                body += '</div>';
                            }
                            if (model.chatMessageDtos[i].hasFile) {
                                body += '<div class="msg-box">';
                                body += '<div>';
                                body += '<div class="chat-msg-attachments">';
                                body += '<div class="chat-attachment">';
                                body += '<img src="/' + model.chatMessageDtos[i].file + '" alt="Attachment">';
                                body += '<div class="chat-attach-caption"></div>';
                                body += '<a href="#" class="chat-attach-download">';
                                body += '<i class="fas fa-download"></i>';
                                body += '</a>';
                                body += '</div>';
                                body += '</div>';
                                body += '<ul class="chat-msg-info">';
                                body += '<li>';
                                body += '<div class="chat-time">';
                                body += '<span>' + model.chatMessageDtos[i].messageHour + '</span>';
                                body += '</div>';
                                body += '</li>';
                                body += '</ul>';
                                body += '</div>';
                                body += '</div>';
                            }
                            if (model.chatMessageDtos[i].hasAudio) {
                                body += '<div class="msg-box">';
                                body += '<div>';
                                body += '<div class="chat-msg-attachments">';
                                body += '<audio controls>';
                                body += '<source src="/' + model.chatMessageDtos[i].audio + '" type="audio/ogg">';
                                body += '</audio>';
                                body += '</div>';
                                body += '<ul class="chat-msg-info">';
                                body += '<li>';
                                body += '<div class="chat-time">';
                                body += '<span>' + model.chatMessageDtos[i].messageHour + '</span>';
                                body += '</div>';
                                body += '</li>';
                                body += '</ul>';
                                body += '</div>';
                                body += '</div>';
                            }
                            body += '</div>';
                            body += '</li>';
                        }
                        document.getElementById("consumerName").innerHTML = model.receiverFullName;
                        document.getElementById("consumerImage").src = "/" + model.receiverIconSrc;
                        $("#messages-Body-Consumer").html(body);
                    }
                }
                else {

                    swal.fire(
                        'هشدار!',
                        data.message,
                        'warning'
                    );
                }
            },
            complete: function() {
                $('#loading').hide(0);
            },
            fail: function() {
                $('#loading').hide(0);
            },
            error: function (request, status, error) {
                alert(request.responseText);
            }

        });
    }

    document.getElementById("sendButton").addEventListener("click", function (event) {

        var addNewMessageForm = new FormData();

        addNewMessageForm.append("chatUserId",ChatUserId);
        addNewMessageForm.append("message",$("#message").val());
        addNewMessageForm.append("file",$("#image").get(0).files[0]);

        $.ajax({
            type: "POST",
            url: '/api/Chat/CheckTime',
            data: addNewMessageForm,
            processData: false,
            contentType: false,
            beforeSend: function(x) {
                $('#loading').show();
            },
            success: function(data) {
                if (data.isSuccess === true) {

                    var time = "@DateTime.Now.Minute : @DateTime.Now.Hour";
                    var user = ChatUserId;
                    var message = $("#message").val();
                    var messageFlag = 0;
                    connection.invoke("SendMessage", user, message,messageFlag,data.data).catch(function (err) {
                        return console.error(err.toString());
                    });

                    document.getElementById('message').value = '';

                    if (data.data == null) {
                        var body2 = $("#messages-Body-Consumer").html();

                        body2 += '<li class="media received">';
                        body2 += '<div class="media-body">';
                        body2 += '<div class="msg-box">';
                        body2 += '<div>';
                        body2 += '<p>';
                        body2 += message;
                        body2 += '</p>';
                        body2 += '<ul class="chat-msg-info">';
                        body2 += '<li>';
                        body2 += '<div class="chat-time">';
                        body2 += '<span>';
                        body2 += time;
                        body2 += '</span>';
                        body2 += '</div>';
                        body2 += '</li>';
                        body2 += '</ul>';
                        body2 += '</div>';
                        body2 += '</div>';
                        body2 += '</div>';
                        body2 += '</li>';

                        $("#messages-Body-Consumer").html("");
                        $("#messages-Body-Consumer").html(body2);
                    } 
                    else {
                        var body = $("#messages-Body-Consumer").html();

                        body += '<li class="media received">';
                        body += '<div class="media-body">';
                        body += '<div class="msg-box">';
                        body += '<div>';
                        body += '<div class="chat-msg-attachments">';
                        body += '<div class="chat-attachment">';
                        body += '<img src="/' + data.data + '" alt="Attachment">';
                        body += '<div class="chat-attach-caption"></div>';
                        body += '<a href="#" class="chat-attach-download">';
                        body += '<i class="fas fa-download"></i>';
                        body += '</a>';
                        body += '</div>';
                        body += '</div>';
                        body += '<ul class="chat-msg-info">';
                        body += '<li>';
                        body += '<div class="chat-time">';
                        body += '<span>' + time + '</span>';
                        body += '</div>';
                        body += '</li>';
                        body += '</ul>';
                        body += '</div>';
                        body += '</div>';
                        body += '</div>';
                        body += '</li>';

                        $("#messages-Body-Consumer").html("");
                        $("#messages-Body-Consumer").html(body);
                    }
                    event.preventDefault();
                }
                else {
                    swal.fire(
                        'هشدار!',
                        data.message,
                        'warning'
                    );
                }
            },
            complete: function() {
                $('#loading').hide();
            },
            fail: function() {
                $('#loading').hide();
            },
            error: function(request, status, error) {
                alert(request.responseText);
            }
        });
    });
</script>
}
